# SC_Timer

### 一个用于线圈电磁加速器的多通道时序控制器

___

+ ###[概述](#overture_zh)
1. [概述](#overture_zh1)
2. [定时功能实现](#overture_zh2)
3. [Demo](#overture_zh3)
4. [关于降低成本](#overture_zh4)
5. [相关接口](#overture_zh5)
6. [输出接口](#overture_zh6)
+ ###[功能](#function_zh)
1. [参数调节](#function_zh1)
2. [时序控制](#function_zh2)
3. [时间格式](#function_zh3)
4. [输出电平调节](#function_zh4)
5. [多配置文件与断电数据保存](#function_zh5)
6. [Busy信号输出](#function_zh6)
+ ###[使用方法](#usage_zh)
1. [开机初始化](#usage_zh1)
2. [使用编码器调整各项参数](#usage_zh2)
3. [屏幕右上角的字母标识](#usage_zh3)
4. [通过USB接口使用上位机调整各项参数](#usage_zh4)
5. [配置文件的自动检查](#usage_zh5)

___

## <span id = "overture_zh">概述</span>
#### 1. <span id = "overture_zh1">概述</span>  
&emsp;&emsp;多级的线圈式电磁加速器一般使用光电门进行检测并且触发每一级的线圈。在更加追求效率的设计内，可能会使用定时触发器精确控制每一级的触发时间。本物便是在此基础上基于STM32平台，使用HAL库进行开发的用于精确控制触发时间以及触发时长的定时器。  
#### 2. <span id = "overture_zh2">定时功能实现</span>  
&emsp;&emsp;核心部分使用STM32的基本定时器产生的硬件中断计数完成，每个计数周期为1us，无累计误差。使用Rigol MSO5072示波器实测1us以上定时时误差在0.1us以内。
#### 3. <span id = "overture_zh3">Demo</span>  
&emsp;&emsp;目前制作的Demo是基于72MHz的STM32F03CxTx进行开发的，一共提供了24通道的定时功能，总定时时长在uint16_t的微秒范围内(不会有人65ms了还没走完管子吧)。  
#### 4. <span id = "overture_zh4">关于降低成本</span>  
&emsp;&emsp;由于提供了12864 OLED的图形UI用于设置参数，以及USB CDC串口使用了便于交互的字符串，这两点占用了巨大的内存空间，导致塞不进几乎不要钱的F103C6T6A。自行阉割相关功能(比如去掉一个设置方法)就可以用几乎不要钱的C6T6A了。
#### 5. <span id = "overture_zh5">相关接口</span>  
&emsp;&emsp;除去通道输出接口外，预留了USB TypeC接口，IIC总线接口以及用于更新固件的SWD接口。通过SGM2205提供一个独立的外置供电(36VDC以内输入)和一个触发按钮端子。  
#### 6. <span id = "overture_zh6">输出接口</span>  
&emsp;&emsp;通过一个2x20p的简易牛角座提供24通道输出，busy信号输出，VIN供电输入，触发按钮输入。其中供电和触发按钮提供额外独立的KF128EDG 2.54mm连接件连接。
## <span id = "function_zh">功能</span>
### 1. <span id = "function_zh1">参数调节</span>
&emsp;&emsp;本设计提供了一块基于SSD1315,使用IIC通信方式的12864 OLED屏幕用于预览、修改参数，以及两种方式用于调整配置，分别是：
+ 带按钮的EC11编码器
+ 通过USB的CDC虚拟串口
### 2. <span id = "function_zh2">时序控制</span>
&emsp;&emsp;本设计通过提供每个通道的两个时间来控制时序，分别是：
+ 开始时间：本通道开始触发的时间
+ 持续时间：本通道触发持续的时间

&emsp;&emsp;时间使用的单位都是us。  
### 3. <span id = "function_zh3">时间格式</span>
&emsp;&emsp;本设计同时支持两种时间输入方式，分别是： 
+ 绝对时间：所有时间以trigger按下起的绝对时间记录
+ 相对时间：所有时间均是距离上一个时间相对的时间记录

例如，以下两个时间列表是等效的：  
+ 绝对时间：  

| 通道   | 开始时间 | 持续时间 |
|------|:----:|:----:|
| CH01 | 10us | 15us |
| CH02 | 25us | 40us |
| CH03 | 50us | 56us |
| CH04 | 58us | 88us |
+ 相对时间：

| 通道   | 开始时间 | 持续时间 |
|------|:----:|:----:|
| CH01 | 10us | 5us  |
| CH02 | 10us | 15us |
| CH03 | 10us | 6us  |
| CH04 | 2us  | 30us |

两种时间格式同时存在并且可以随时互相切换
### 4. <span id = "function_zh4">输出电平调节</span>
&emsp;&emsp;本设计支持调整输出通道的使能电平(高电平使能或者低电平使能)，两者可以随时切换
### 5. <span id = "function_zh5">多配置文件与断电数据保存</span>
&emsp;&emsp;本设计目前支持8个独立的配置文件(不超出Flash一页随便几个)，均具备断电保存数据功能。数据保存在单片机Flash的最尾部页。
### 6. <span id = "function_zh6">Busy信号输出</span>
&emsp;&emsp;在运行时序定时输出时，提供一个低电平使能的Busy信号，并在结束定时输出时拉回高电平，可用于控制ZVS在触发时停止充电。暂不支持切换Busy信号使能电平(PCB上做了LED，扣掉就好改，程序也没写死)

---
## <span id = "usage_zh">使用方法</span>
### 1. <span id = "usage_zh1">开机初始化</span>
&emsp;&emsp;系统开机时会自动检测Flash指定位置是否有写入Flag。若存在Flag则会从Flash中读取配置; 若不存在Flag则加载初始化数据，同时屏幕上显示“Init from reset”字样。
### 2. <span id = "usage_zh2">使用编码器调整各项参数</span>
&emsp;&emsp;本设计配备了一个EC11编码器用于脱机调节参数，调节系统基于状态机构建，以下是各状态之间的流程图：

####1. 默认状态：系统默认的状态，显示配置文件编号以及各通道参数。

&emsp;&emsp;注意：只有此状态下可以通过Trigger触发输出
+ 短按编码器按钮，进入状态3
+ 长按编码器按钮，进入状态2
+ 连按两下编码器按钮，改变绝对时间与相对时间之间切换显示
+ 转动编码器，改变显示的通道。每页同时显示3个通道，头尾循环
####2. 高亮配置文件状态
+ 短按编码器按钮，进入状态1
+ 长按编码器按钮，进入状态8
+ 连按两下编码器按钮，改变绝对时间与相对时间之间切换显示
+ 转动编码器，改变显示配置文件编号
####3. 高亮通道状态
+ 短按编码器按钮，进入状态4
+ 长按编码器按钮，进入状态1(退出时间设置)，若产生修改，将会在此处检查参数并保存
+ 转动编码器，改变高亮显示的通道，首尾循环
####4. 高亮开始时间(时间1)状态
+ 短按编码器按钮，进入状态6
+ 长按编码器按钮，进入状态3
+ 连按两下编码器按钮，进入状态5
####5. 时间1逐位选择状态
+ 短按编码器按钮，切换高亮显示的位数，首尾循环
+ 长按编码器按钮，进入状态4(退出该时间设定)
+ 转动编码器，改变高亮显示的数字，在数字不超出65535的情况下首尾循环
####6. 高亮持续时间(时间2)状态
+ 短按编码器按钮，进入状态3
+ 长按编码器按钮，进入状态3
+ 连按两下编码器按钮，进入状态7
####7. 时间2逐位选择状态
+ 短按编码器按钮，切换高亮显示的位数，首尾循环
+ 长按编码器按钮，进入状态6(退出该时间设定)
+ 转动编码器，改变高亮显示的数字，在数字不超出65535的情况下首尾循环
####8. 高亮使能电平状态
+ 短按编码器按钮，进入状态1(退出使能电平设置)，若使能电平发生更改，此时将立即写入Flash
+ 转动编码器，改变使能电平，两者间循环

### 3.<span id = "usage_zh3">屏幕右上角的字母标识</span>
+ U：显示时表示建立了有效的USB数据连接（不包含仅USB口供电）
+ A/R：表示当前时间显示模式。A为绝对时间模式，R为相对时间模式
+ H/L：表示当前输出通道使能电平。H为高电平使能，L为低电平使能

### 4.<span id = "usage_zh4">通过USB接口使用上位机调整各项参数</span>
&emsp;&emsp;本设计集成了基于USB2.0 FullSpeed的USB通信接口，使用CDC虚拟串口，通过字符串指令进行交互。
在Windows10以及Windows11系统上无需驱动，使用XCOM,SSCOM等串口调试软件即可直接连接。系统命令均以 '$' 字符开头。系统提供了如下命令：  

```bash
>>$$ #打印欢迎界面
>>$? #打印指令帮助
$t #设置输出使能电平(立刻保存)
>>$t <0-Low/1-High>
$sa #通过绝对时间模式设定时间参数
>> $ss <profile> <channel> <value_type(1-begin_time/2-duration)> <value>
$sr #通过相对时间模式设定时间参数
>> $sr <profile> <channel> <value_type(1-begin_time/2-duration)> <value>
$ra #通过绝对时间模式打印指定配置文件
>>$ra <profile>
$rr #通过相对时间模式打印指定配置文件
>>$rr <profile>
$e #立即触发指定配置文件(需要保证脱机设置系统处于状态1)
>>$e <profile>
$u - #将更改保存到Flash内($s设置的参数直到$u前不会保存到Flash内，但是触发时依旧使用设置后的参数)
>>$u
```
###5. <span id = "usage_zh5">配置文件的自动检查</span>
&emsp;&emsp;本设计在以下几个时刻，会检查设定的参数是否合法，只有合法参数可以被用于触发：
+ 脱机设置系统从状态3退出到状态1的时候
+ USB CDC设置通过$s指令设置参数的时候  

&emsp;&emsp;配置文件检查失败的时候，将会在屏幕/CDC串口 上显示对应的报错信息，提示哪一个参数存在问题。